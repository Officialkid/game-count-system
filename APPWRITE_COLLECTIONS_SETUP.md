# Appwrite Collections & Storage Setup

**Goal:** Create collections and storage buckets in Appwrite Console to support all application features.

**Project:** `694164500028df77ada9`  
**Database:** `main` (created in Phase A)

---

## Quick Reference Table

### Collections

| Collection | Attributes | Indexes | Phase | Status |
|---|---|---|---|---|
| events | 10 fields | user_id, status, created_at | C | Instructions below |
| teams | 5 fields | event_id, team_name | C | Instructions below |
| scores | 7 fields | composite (event_id, team_id, game_number) | C/D | Instructions below |
| recaps | 3 fields | event_id, generated_at | C | Instructions below |
| share_links | 5 fields | token (unique), event_id | E | Instructions below |
| audit_logs | 5 fields | user_id, timestamp | 4+ | Optional |

### Storage Buckets

| Bucket | Purpose | Max File Size | Allowed Types | Phase |
|---|---|---|---|---|
| logos | Event logos | 10MB | PNG, JPG | E |
| avatars | Team avatars | 5MB | PNG, JPG | E |

---

## Step-by-Step Setup

### Prerequisites
- Appwrite Console open: https://cloud.appwrite.io/console/project-694164500028df77ada9/databases/main
- Database `main` already created (Phase A)

---

## Collection 1: events

**Purpose:** Store event metadata (name, status, settings)

**Setup in Console:**

1. Click **Add Collection** in the `main` database
2. **Collection ID:** `events`
3. **Collection Name:** Events
4. Click **Create**

**Add Attributes:**

| Name | Type | Size | Required | Default |
|---|---|---|---|---|
| user_id | String | 255 | Yes | — |
| event_name | String | 255 | Yes | — |
| theme_color | String | 7 | No | #7c3aed |
| logo_path | String | 500 | No | null |
| allow_negative | Boolean | — | No | false |
| display_mode | String | 50 | No | cumulative |
| num_teams | Integer | — | No | 2 |
| status | String | 50 | No | draft |
| created_at | DateTime | — | Yes | $now |
| updated_at | DateTime | — | Yes | $now |

**Add Indexes:**

| Index Name | Attributes | Type |
|---|---|---|
| user_id_idx | user_id (ASC) | Unique: No |
| status_idx | status (ASC) | Unique: No |
| created_idx | created_at (DESC) | Unique: No |

**Set Permissions:**

In collection **Settings → Permissions**:

- **Create:** Role = Users
- **Read:** Inherit from document (creator only via document permissions)
- **Update:** Inherit from document (creator only)
- **Delete:** Inherit from document (creator only)

**Document Permissions** (set at creation time by SDK):
```
user:{USER_ID}
```

---

## Collection 2: teams

**Purpose:** Store team data within an event

**Setup in Console:**

1. Click **Add Collection** in the `main` database
2. **Collection ID:** `teams`
3. **Collection Name:** Teams
4. Click **Create**

**Add Attributes:**

| Name | Type | Size | Required | Default |
|---|---|---|---|---|
| event_id | String | 255 | Yes | — |
| team_name | String | 255 | Yes | — |
| avatar_path | String | 500 | No | null |
| total_points | Integer | — | No | 0 |
| created_at | DateTime | — | No | $now |

**Add Indexes:**

| Index Name | Attributes | Type |
|---|---|---|
| event_id_idx | event_id (ASC) | Unique: No |
| team_name_idx | team_name (ASC) | Unique: No |
| points_idx | total_points (DESC) | Unique: No |

**Set Permissions:**

Same as events:
- **Create:** Users
- **Read/Update/Delete:** Document permissions (creator only)

---

## Collection 3: scores

**Purpose:** Individual game scores for each team

**Setup in Console:**

1. Click **Add Collection** in the `main` database
2. **Collection ID:** `scores`
3. **Collection Name:** Scores
4. Click **Create**

**Add Attributes:**

| Name | Type | Size | Required | Default | Notes |
|---|---|---|---|---|---|
| event_id | String | 255 | Yes | — | |
| team_id | String | 255 | Yes | — | |
| game_number | Integer | — | Yes | — | |
| points | Integer | — | Yes | — | |
| user_id | String | 255 | Yes | — | |
| created_at | DateTime | — | No | $now | |
| client_score_id | String | 255 | No | null | Phase D: Idempotency key |

**Add Indexes:**

| Index Name | Attributes | Type | Notes |
|---|---|---|---|
| event_id_idx | event_id (ASC) | Unique: No | Query by event |
| team_id_idx | team_id (ASC) | Unique: No | Query by team |
| game_idx | game_number (ASC) | Unique: No | Sort by game |
| composite_idx | event_id, team_id, game_number | Unique: Yes | Support upsert |

**Composite Index Creation:**

1. Go to collection **Settings → Indexes**
2. Click **Add Index**
3. **Index Name:** `composite_idx`
4. **Attributes:** 
   - event_id (ASC)
   - team_id (ASC)
   - game_number (ASC)
5. **Type:** Unique (Yes)
6. Click **Create**

**Important Notes:**

- **client_score_id** (Phase D): Optional idempotency key generated by client (UUID). The `submitScoreHandler` Appwrite Function checks this field before creating scores to prevent duplicate submissions. If a score with the same `client_score_id` already exists, the function returns the existing score instead of creating a duplicate.

**Set Permissions:**

Same as above (creator only).

---

## Collection 4: recaps

**Purpose:** Store event recap snapshots (JSON summaries)

**Setup in Console:**

1. Click **Add Collection** in the `main` database
2. **Collection ID:** `recaps`
3. **Collection Name:** Recaps
4. Click **Create**

**Add Attributes:**

| Name | Type | Size | Required | Default |
|---|---|---|---|---|
| event_id | String | 255 | Yes | — |
| snapshot | JSON | — | Yes | — |
| generated_at | DateTime | — | No | $now |

**Add Indexes:**

| Index Name | Attributes | Type |
|---|---|---|
| event_id_idx | event_id (ASC) | Unique: No |
| generated_idx | generated_at (DESC) | Unique: No |

**Set Permissions:**

Same as above (creator only).

---

## Collection 5: share_links (Phase E - Public Scoreboard)

**Purpose:** Store public share tokens for event scoreboards

**Setup in Console:**

1. Click **Add Collection** in the `main` database
2. **Collection ID:** `share_links`
3. **Collection Name:** Share Links
4. Click **Create**

**Add Attributes:**

| Name | Type | Size | Required | Default | Notes |
|---|---|---|---|---|---|
| event_id | String | 255 | Yes | — | Reference to events.$id |
| token | String | 64 | Yes | — | Unique public share token |
| is_active | Boolean | — | No | true | Deactivate instead of delete |
| created_at | DateTime | — | No | $now | Link creation time |
| expires_at | DateTime | — | No | null | Optional expiration |

**Add Indexes:**

| Index Name | Attributes | Type | Unique |
|---|---|---|---|
| token_idx | token (ASC) | key | Yes |
| event_id_idx | event_id (ASC) | key | No |
| active_idx | is_active (ASC) | key | No |

**Set Permissions:**

⚠️ **IMPORTANT: Public Read Required**

In collection **Settings → Permissions**:

- **Create:** Role = Users (authenticated users can create links)
- **Read:** Role = Any (public scoreboard access without auth)
- **Update:** Inherit from document (owner can deactivate/regenerate)
- **Delete:** Inherit from document (owner can delete)

**Document Permissions** (set at creation time by SDK):
```typescript
[
  Permission.read(Role.any()),           // Public read
  Permission.update(Role.user(userId)),  // Owner can update
  Permission.delete(Role.user(userId))   // Owner can delete
]
```

**Important Notes:**

- **token** must be unique - use generateShareToken() from appwriteShareLinks service
- **Public read** allows scoreboard access without authentication
- Instead of deleting links, set `is_active = false` to preserve history
- Use composite query: `Query.equal('token', token), Query.equal('is_active', true)`

---

## Collection 6: audit_logs (Phase F - Admin & Audit)

**Purpose:** Track all system changes for auditing and compliance

**Setup in Console:**

1. Click **Add Collection** in the `main` database
2. **Collection ID:** `audit_logs`
3. **Collection Name:** Audit Logs
4. Click **Create**

**Add Attributes:**

| Name | Type | Size | Required | Default | Notes |
|---|---|---|---|---|---|
| user_id | String | 255 | Yes | — | User who performed action |
| action | String | 100 | Yes | — | Action type (e.g., score.create) |
| entity | String | 50 | Yes | — | Entity type (scores, events, etc.) |
| record_id | String | 255 | Yes | — | Affected document ID |
| details | JSON | — | No | null | Additional context/changes |
| ip_address | String | 45 | No | null | Client IP address |
| user_agent | String | 500 | No | null | Client user agent |
| timestamp | DateTime | — | No | $now | When action occurred |

**Add Indexes:**

| Index Name | Attributes | Type | Notes |
|---|---|---|---|
| user_id_idx | user_id (ASC) | key | Query by user |
| timestamp_idx | timestamp (DESC) | key | Sort by recency |
| action_idx | action (ASC) | key | Filter by action type |
| entity_idx | entity (ASC) | key | Filter by entity |
| record_idx | record_id (ASC) | key | Get history for specific record |

**Set Permissions:**

⚠️ **IMPORTANT: Immutable Logs**

In collection **Settings → Permissions**:

- **Create:** Role = Users (authenticated users can create logs via function)
- **Read:** Role = Users (authenticated users can read logs)
  - Note: For stricter access, use document-level permissions
  - Admins can read all, users can read only their own
- **Update:** DISABLED (logs are immutable)
- **Delete:** DISABLED (logs are permanent)

**Document Permissions** (set by logAudit function):
```typescript
[
  Permission.read(Role.user(userId)),    // User can read their own logs
  Permission.read(Role.label('admin'))   // Admins can read all logs
]
```

**Action Naming Convention:**

Use dot notation for consistency:
- `score.create`, `score.update`, `score.delete`
- `event.create`, `event.update`, `event.delete`
- `team.create`, `team.update`, `team.delete`
- `user.login`, `user.logout`, `user.register`
- `user.role_change`, `user.invite`, `user.password_reset`

**Integration:**

Audit logs are created automatically via the `logAudit` Appwrite Function:
- Called from `submitScoreHandler`, `generateRecap`, and other functions
- Can be called from frontend via API routes
- See `appwrite/functions/logAudit/` for implementation

---

- **Create:** Users
- **Read:** Admin or creator
- **Update/Delete:** Disabled (immutable logs)

---

## Verification Checklist

After creating all collections:

- [ ] `main` database exists
- [ ] `events` collection with 10 attributes + 3 indexes
- [ ] `teams` collection with 5 attributes + 3 indexes
- [ ] `scores` collection with 6 attributes + 4 indexes (including composite)
- [ ] `recaps` collection with 3 attributes + 2 indexes
- [ ] All collections have document-level permissions set
- [ ] Permissions allow "Create: Users"
- [ ] Indexes match Phase C data models

**To Verify in Console:**

1. Go to each collection
2. Check **Attributes** tab
3. Check **Indexes** tab
4. Check **Settings → Permissions** tab

---

## Testing Collections via Console

Once collections are created, test in **Appwrite Console → Database**:

### Test 1: Create an Event

```json
{
  "user_id": "user-123",
  "event_name": "Game Night",
  "theme_color": "#7c3aed",
  "status": "draft",
  "num_teams": 2
}
```

**Expected:** Document created with ID, timestamps auto-populated

### Test 2: Create a Team

```json
{
  "event_id": "event-xyz",
  "team_name": "Red Team",
  "total_points": 0
}
```

**Expected:** Document created, can link to event

### Test 3: Add a Score

```json
{
  "event_id": "event-xyz",
  "team_id": "team-abc",
  "game_number": 1,
  "points": 50,
  "user_id": "user-123"
}
```

**Expected:** Document created, composite index enforces uniqueness

### Test 4: Upsert Score (Update)

Create score with same event_id, team_id, game_number but different points:

**Expected:** Fails (unique constraint) or creates new if using composite query

---

## Permissions Deep Dive

### Document-Level Access (Recommended)

When creating a document via SDK, pass permissions:

```typescript
const permissions = [`user:{USER_ID}`];
await databases.createDocument(
  DATABASE_ID,
  COLLECTION_ID,
  docId,
  payload,
  permissions
);
```

This ensures only the creator can read/update/delete their document.

### Collection-Level Permissions (Broad)

If you want all authenticated users to read all events (public):

1. Go to collection **Settings → Permissions**
2. **Read:** Role = Users
3. Check "Allow"

**Use case:** Public event browser (later phases)

### Mixed Permissions (Advanced)

Some data public, some private:

1. Share links collection: **Read** = Public (anyone can view via share token)
2. Events collection: **Read** = Document-level (only creator)

---

## Troubleshooting

**Issue:** "Cannot create document - permission denied"  
**Solution:** Check collection permissions allow "Create: Users"

**Issue:** "Duplicate key violation"  
**Solution:** The composite index on (event_id, team_id, game_number) prevents duplicates. Use `updateDocument` instead of `createDocument` for upserts.

**Issue:** "Cannot query with these attributes"  
**Solution:** Verify indexes exist for query fields (see Appwrite docs on required indexes)

---

## Next Steps (Phase C CRUD)

Once collections are created:

1. ✅ Collections exist in Appwrite
2. ✅ Indexes configured
3. ✅ Permissions set
4. → Test CRUD via SDK (`lib/services/appwrite*.ts`)
5. → Add service toggle env var
6. → Replace mock services

---

## Service Files Reference

After collections are ready:

- `lib/services/appwriteEvents.ts` - Events CRUD
- `lib/services/appwriteTeams.ts` - Teams CRUD
- `lib/services/appwriteScores.ts` - Scores CRUD
- `lib/services/appwriteRecaps.ts` - Recaps CRUD
- `lib/services/appwriteShareLinks.ts` - Share Links (Phase E)
- `lib/services/appwriteStorage.ts` - File Uploads (Phase E)

All use the collection IDs from this guide.

---

## Phase E: Storage Buckets Setup

**Purpose:** Store team avatars and event logos in Appwrite Storage

### Prerequisites
- Appwrite Console open: https://cloud.appwrite.io/console/project-694164500028df77ada9/storage

---

### Bucket 1: logos

**Purpose:** Event logo images

**Setup in Console:**

1. Go to **Storage** in Appwrite Console
2. Click **Create Bucket**
3. **Bucket ID:** `logos`
4. **Bucket Name:** Event Logos
5. **Max File Size:** 10MB (10485760 bytes)
6. **Allowed File Extensions:** `png`, `jpg`, `jpeg`
7. Click **Create**

**Set Bucket Permissions:**

In bucket **Settings → Permissions**:

- **Create:** Role = Users (authenticated users can upload)
- **Read:** File-level permissions (set per file based on owner)
- **Update:** File-level permissions (owner can replace)
- **Delete:** File-level permissions (owner can delete)

**File Permissions** (set at upload time by SDK):
```typescript
[
  Permission.read(Role.user(userId)),    // Owner can view
  Permission.update(Role.user(userId)),  // Owner can update
  Permission.delete(Role.user(userId))   // Owner can delete
]
```

---

### Bucket 2: avatars

**Purpose:** Team avatar images

**Setup in Console:**

1. Go to **Storage** in Appwrite Console
2. Click **Create Bucket**
3. **Bucket ID:** `avatars`
4. **Bucket Name:** Team Avatars
5. **Max File Size:** 5MB (5242880 bytes)
6. **Allowed File Extensions:** `png`, `jpg`, `jpeg`
7. Click **Create**

**Set Bucket Permissions:**

Same as logos bucket above.

**File Permissions** (set at upload time by SDK):
```typescript
[
  Permission.read(Role.user(userId)),
  Permission.update(Role.user(userId)),
  Permission.delete(Role.user(userId))
]
```

---

### Storage Configuration in .env.local

After creating buckets, update your `.env.local`:

```bash
# Appwrite Storage Buckets (Phase E)
NEXT_PUBLIC_APPWRITE_BUCKET_LOGOS="logos"
NEXT_PUBLIC_APPWRITE_BUCKET_AVATARS="avatars"
```

---

### Storage Service Usage

```typescript
import { storageService } from '@/lib/services';

// Upload event logo
const result = await storageService.uploadEventLogo(file, userId, eventId);
if (result.success) {
  console.log('Logo URL:', result.data.fileUrl);
  console.log('File ID:', result.data.fileId);
}

// Upload team avatar
const avatarResult = await storageService.uploadTeamAvatar(file, userId, teamId);

// Get file preview URL
const previewUrl = storageService.getFilePreviewUrl('logos', fileId, 800, 600);

// Delete file
await storageService.deleteFile('logos', fileId);
```

---

### Storage Verification Checklist

- [ ] `logos` bucket created with 10MB limit
- [ ] `avatars` bucket created with 5MB limit
- [ ] File extensions restricted to png, jpg, jpeg
- [ ] Bucket permissions set to file-level
- [ ] Environment variables updated in `.env.local`
- [ ] Test upload via LogoUpload component

---

**Estimated time:** 5-10 minutes for both buckets

---

## Complete Verification Checklist

### Phase C: Collections
- [ ] `main` database exists
- [ ] `events` collection with 10 attributes + 3 indexes
- [ ] `teams` collection with 5 attributes + 3 indexes
- [ ] `scores` collection with 7 attributes + 4 indexes (including composite)
- [ ] `recaps` collection with 3 attributes + 2 indexes

### Phase E: Share Links & Storage
- [ ] `share_links` collection with 5 attributes + 3 indexes
- [ ] `share_links` has PUBLIC read permission (Role.any())
- [ ] `logos` bucket with 10MB limit, PNG/JPG only
- [ ] `avatars` bucket with 5MB limit, PNG/JPG only
- [ ] Storage buckets have file-level permissions

### General
- [ ] All collections have document-level permissions set
- [ ] Permissions allow "Create: Users"
- [ ] All indexes created successfully
- [ ] `.env.local` updated with bucket IDs

---

**Total estimated time:** 20-30 minutes for all collections and storage

